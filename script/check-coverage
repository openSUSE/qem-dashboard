#!/usr/bin/perl
use strict;
use warnings;
use Devel::Cover::DB;

my $cover = Devel::Cover::DB->new(db => "cover_db");
if (!$cover) {
    die "Failed to load coverage database from cover_db";
}

# Fallback to internal hash keys if files() method is not available in this version
my @files;
if ($cover->can('files')) {
    @files = $cover->files;
} else {
    @files = keys %{$cover->{file}};
}

@files = grep { /^lib\/|t\// && !/Wrappers/ && !/Database\.pm/ } @files;

my $failed = 0;
$failed += check_coverage('statement', 100, \@files);
$failed += check_coverage('branch', 100, \@files);

if ($failed) {
    print "\nGenerating detailed coverage report due to failuresâ€¦\n";
    system("cover", "-report", "text");
    exit 1;
}

print "SUCCESS: All backend and test files (lib/ and t/) have complete statement and branch coverage.\n";

sub check_coverage {
    my ($type, $threshold, $files) = @_;
    my @failed;
    for my $file (@$files) {
        my $f = $cover->file($file);
        next unless $f;
        my $criterion = $f->$type();
        if (!$criterion) {
            # Some files might not have branches
            next if $type eq 'branch';
            push @failed, $file;
            next;
        }
        my $coverage = $criterion->percentage;
        push @failed, sprintf("%s: %.1f%%", $file, $coverage) if $coverage < $threshold;
    }

    if (@failed) {
        print "ERROR: The following files do not have complete $type coverage:\n";
        print join("\n", map { "  $_" } @failed), "\n";
        return 1;
    }
    return 0;
}
